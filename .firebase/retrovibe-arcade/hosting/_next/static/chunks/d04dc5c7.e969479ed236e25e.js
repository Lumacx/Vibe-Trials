"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[817],{51860:(e,t,r)=>{r.d(t,{Ay:()=>J});var n,i,s,o,a,c=r(34931),l=r(87328),h=r(17099),u=r(31666),d=r(11615),f=r(4747);class y extends c.fg{address;keychain;modal;options;constructor(e,t,r,n,i,s){super({nodeUrl:t},e),this.address=r,this.keychain=n,this.options=i,this.modal=s}async execute(e){return e=(0,l.t)(e),new Promise(async(t,r)=>{let n=await this.keychain.execute(e,void 0,void 0,!1,this.options?.feeSource);if(n.code===l.R.SUCCESS)return void t(n);if(this.options?.propagateSessionErrors&&n.code!==l.R.USER_INTERACTION_REQUIRED)return void r(n.error);this.modal.open();let i=await this.keychain.execute(e,void 0,void 0,!0,n.error);if(i.code===l.R.SUCCESS){t(i),this.modal.close();return}r(i.error)})}async signMessage(e){return new Promise(async(t,r)=>{let n=await this.keychain.signMessage(e,"",!0);if(!("code"in n))return void t(n);this.modal.open();let i=await this.keychain.signMessage(e,"",!1);"code"in i?r(i.error):t(i),this.modal.close()})}}!function(e){e.Call="call",e.Reply="reply",e.Syn="syn",e.SynAck="synAck",e.Ack="ack"}(n||(n={})),function(e){e.Fulfilled="fulfilled",e.Rejected="rejected"}(i||(i={})),function(e){e.ConnectionDestroyed="ConnectionDestroyed",e.ConnectionTimeout="ConnectionTimeout",e.NoIframeSrc="NoIframeSrc"}(s||(s={})),(o||(o={})).DataCloneError="DataCloneError",(a||(a={})).Message="message";let p=(e,t)=>{let r=[],n=!1;return{destroy(i){n||(n=!0,t(`${e}: Destroying connection`),r.forEach(e=>{e(i)}))},onDestroy(e){n?e():r.push(e)}}},g=e=>(...t)=>{e&&console.log("[Penpal]",...t)},w={"http:":"80","https:":"443"},m=/^(https?:)?\/\/([^/:]+)?(:(\d+))?/,v=["file:","data:"],b=e=>{let t,r,n;if(e&&v.find(t=>e.startsWith(t)))return"null";let i=document.location,s=m.exec(e);s?(t=s[1]?s[1]:i.protocol,r=s[2],n=s[4]):(t=i.protocol,r=i.hostname,n=i.port);let o=n&&n!==w[t]?`:${n}`:"";return`${t}//${r}${o}`},k=({name:e,message:t,stack:r})=>({name:e,message:t,stack:r}),A=e=>{let t=Error();return Object.keys(e).forEach(r=>t[r]=e[r]),t},E=(e,t,r)=>{let{localName:s,local:c,remote:l,originForSending:h,originForReceiving:u}=e,d=!1,f=e=>{if(e.source!==l||e.data.penpal!==n.Call)return;if("*"!==u&&e.origin!==u)return void r(`${s} received message from origin ${e.origin} which did not match expected origin ${u}`);let{methodName:a,args:c,id:f}=e.data;r(`${s}: Received ${a}() call`);let y=e=>t=>{if(r(`${s}: Sending ${a}() reply`),d)return void r(`${s}: Unable to send ${a}() reply due to destroyed connection`);let c={penpal:n.Reply,id:f,resolution:e,returnValue:t};e===i.Rejected&&t instanceof Error&&(c.returnValue=k(t),c.returnValueIsError=!0);try{l.postMessage(c,h)}catch(e){if(e.name===o.DataCloneError){let t={penpal:n.Reply,id:f,resolution:i.Rejected,returnValue:k(e),returnValueIsError:!0};l.postMessage(t,h)}throw e}};new Promise(r=>r(t[a].call(t,e.origin).apply(t,c))).then(y(i.Fulfilled),y(i.Rejected))};return c.addEventListener(a.Message,f),()=>{d=!0,c.removeEventListener(a.Message,f)}},C=0,I=()=>++C,P=e=>e?e.split("."):[],S=e=>e.join("."),M=(e,t)=>{let r=P(t||"");return r.push(e),S(r)},U=(e,t,r)=>{let n=P(t);return n.reduce((e,t,i)=>(typeof e[t]>"u"&&(e[t]={}),i===n.length-1&&(e[t]=r),e[t]),e),e},N=(e,t)=>{let r={};return Object.keys(e).forEach(n=>{let i=e[n],s=M(n,t);"object"==typeof i&&Object.assign(r,N(i,s)),"function"==typeof i&&(r[s]=i)}),r},R=e=>{let t={};for(let r in e)U(t,r,e[r]);return t},$=(e,t,r,o,c)=>{let{localName:l,local:h,remote:u,originForSending:d,originForReceiving:f}=t,y=!1;c(`${l}: Connecting call sender`);let p=e=>(...t)=>{let r;c(`${l}: Sending ${e}() call`);try{u.closed&&(r=!0)}catch{r=!0}if(r&&o(),y){let t=Error(`Unable to send ${e}() call due to destroyed connection`);throw t.code=s.ConnectionDestroyed,t}return new Promise((r,s)=>{let o=I(),y=t=>{if(t.source!==u||t.data.penpal!==n.Reply||t.data.id!==o)return;if("*"!==f&&t.origin!==f)return void c(`${l} received message from origin ${t.origin} which did not match expected origin ${f}`);let d=t.data;c(`${l}: Received ${e}() reply`),h.removeEventListener(a.Message,y);let p=d.returnValue;d.returnValueIsError&&(p=A(p)),(d.resolution===i.Fulfilled?r:s)(p)};h.addEventListener(a.Message,y);let p={penpal:n.Call,id:o,methodName:e,args:t};u.postMessage(p,d)})};return Object.assign(e,R(r.reduce((e,t)=>(e[t]=p(t),e),{}))),()=>{y=!0}},x=(e,t,r,n,i)=>{let s,o,{destroy:a,onDestroy:c}=n,l={};return n=>{if("*"!==t&&n.origin!==t)return void i(`Parent: Handshake - Received ACK message from origin ${n.origin} which did not match expected origin ${t}`);i("Parent: Handshake - Received ACK");let h={localName:"Parent",local:window,remote:n.source,originForSending:r,originForReceiving:t};return s&&s(),c(s=E(h,e,i)),o&&o.forEach(e=>{delete l[e]}),c($(l,h,o=n.data.methodNames,a,i)),l}},B=(e,t,r,i)=>s=>{if(!s.source)return;if("*"!==r&&s.origin!==r)return void e(`Parent: Handshake - Received SYN message from origin ${s.origin} which did not match expected origin ${r}`);e("Parent: Handshake - Received SYN, responding with SYN-ACK");let o={penpal:n.SynAck,methodNames:Object.keys(t)};s.source.postMessage(o,i)},T=(e,t)=>{let{destroy:r,onDestroy:n}=t,i=setInterval(()=>{e.isConnected||(clearInterval(i),r())},6e4);n(()=>{clearInterval(i)})},D=(e,t)=>{let r;return void 0!==e&&(r=window.setTimeout(()=>{let r=Error(`Connection timed out after ${e}ms`);r.code=s.ConnectionTimeout,t(r)},e)),()=>{clearTimeout(r)}},O=e=>{if(!e.src&&!e.srcdoc){let e=Error("Iframe must have src or srcdoc property defined.");throw e.code=s.NoIframeSrc,e}},L=e=>{let{iframe:t,methods:r={},childOrigin:i,timeout:s,debug:o=!1}=e,c=g(o),l=p("Parent",c),{onDestroy:h,destroy:u}=l;i||(O(t),i=b(t.src));let d="null"===i?"*":i,f=N(r),y=B(c,f,i,d),w=x(f,i,d,l,c);return{promise:new Promise((e,r)=>{let i=D(s,u),o=r=>{if(!(r.source!==t.contentWindow||!r.data)){if(r.data.penpal===n.Syn)return void y(r);if(r.data.penpal===n.Ack){let t=w(r);t&&(i(),e(t));return}}};window.addEventListener(a.Message,o),c("Parent: Awaiting handshake"),T(t,l),h(e=>{window.removeEventListener(a.Message,o),e&&r(e)})}),destroy(){u()}}};class _{url;iframe;container;onClose;constructor({id:e,url:t,preset:r,onClose:n,onConnect:i,methods:s={}}){if(typeof document>"u")return;r&&t.searchParams.set("preset",r),this.url=t;let o=document.createElement("iframe");o.src=t.toString(),o.id=e,o.style.border="none",o.sandbox.add("allow-forms"),o.sandbox.add("allow-popups"),o.sandbox.add("allow-popups-to-escape-sandbox"),o.sandbox.add("allow-scripts"),o.sandbox.add("allow-same-origin"),o.allow="publickey-credentials-create *; publickey-credentials-get *; clipboard-write",document.hasStorageAccess&&o.sandbox.add("allow-storage-access-by-user-activation");let a=document.createElement("div");a.id="controller",a.style.position="fixed",a.style.height="100%",a.style.width="100%",a.style.top="0",a.style.left="0",a.style.zIndex="10000",a.style.backgroundColor="rgba(0,0,0,0.6)",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.visibility="hidden",a.style.opacity="0",a.style.transition="opacity 0.2s ease",a.style.pointerEvents="auto",a.appendChild(o),this.iframe=o,this.container=a,L({iframe:this.iframe,methods:{close:e=>()=>this.close(),closeAll:e=>()=>{document.querySelectorAll('iframe[id^="controller-"]').forEach(e=>{let t=e.parentElement;t&&(t.style.visibility="hidden",t.style.opacity="0")}),document.body.style.overflow="auto"},reload:e=>()=>window.location.reload(),...s}}).promise.then(i),this.resize(),window.addEventListener("resize",()=>this.resize());let c=new MutationObserver(()=>{let t=document.getElementById("controller");document.body&&("controller-keychain"===e&&!t||"controller-profile"===e)&&(document.body.appendChild(a),c.disconnect())});c.observe(document.documentElement,{childList:!0,subtree:!0});let l=document.getElementById("controller");document.body&&("controller-keychain"===e&&!l||"controller-profile"===e)&&document.body.appendChild(a),this.onClose=n}open(){this.container&&(document.body.style.overflow="hidden",this.container.style.visibility="visible",this.container.style.opacity="1")}close(){this.container&&(this.onClose?.(),document.body.style.overflow="auto",this.container.style.visibility="hidden",this.container.style.opacity="0")}sendBackward(){this.container&&(this.container.style.zIndex="9999")}sendForward(){this.container&&(this.container.style.zIndex="10000")}resize(){if(this.iframe){if(this.iframe.style.userSelect="none",window.innerWidth<768){this.iframe.style.height="100%",this.iframe.style.width="100%",this.iframe.style.borderRadius="0";return}this.iframe.style.height="600px",this.iframe.style.width="432px",this.iframe.style.borderRadius="8px"}}}class F{type="argent";platform="starknet";wallet=void 0;account=void 0;connectedAccounts=[];isAvailable(){return"u">typeof window&&!!window.starknet_argentX}getInfo(){let e=this.isAvailable();return{type:this.type,available:e,version:e?window.starknet_argentX?.version||"Unknown":void 0,chainId:e?window.starknet_argentX?.chainId:void 0,name:"Argent",platform:this.platform}}async connect(){if(this.account)return{success:!0,wallet:this.type,account:this.account};try{if(!this.isAvailable())throw Error("Argent is not available");let{wallet:e,connectorData:t}=await (0,h.Ng)({connectors:[new u.s({options:{id:"argentX"}})]});if(!e)throw Error("No wallet found");return this.wallet=e,this.account=t?.account,{success:!0,wallet:this.type,account:this.account}}catch(e){return console.error("Error connecting to Argent:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}getConnectedAccounts(){return this.connectedAccounts}async signTypedData(e){try{if(!this.isAvailable()||!this.wallet)throw Error("Argent is not connected");let t=await this.wallet.request({type:"wallet_signTypedData",params:e});return{success:!0,wallet:this.type,result:t}}catch(e){return console.error("Error signing typed data with Argent:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}async sendTransaction(e){return{success:!1,wallet:this.type,error:"Not implemented"}}async switchChain(e){return console.warn("Chain switching for Argent may require custom implementation"),!1}async getBalance(e){try{if(!this.isAvailable()||!this.wallet)throw Error("Argent is not connected");return{success:!0,wallet:this.type,result:"Implement based on Argent API"}}catch(e){return console.error("Error getting balance from Argent:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}}function j(){let e=new Set,t=[],r=()=>(function(e){if(typeof window>"u")return;let t=t=>e(t.detail);return window.addEventListener("eip6963:announceProvider",t),window.dispatchEvent(new CustomEvent("eip6963:requestProvider")),()=>window.removeEventListener("eip6963:announceProvider",t)})(r=>{t.some(({info:e})=>e.uuid===r.info.uuid)||(t=[...t,r],e.forEach(e=>e(t,{added:[r]})))}),n=r();return{_listeners:()=>e,clear(){e.forEach(e=>e([],{removed:[...t]})),t=[]},destroy(){this.clear(),e.clear(),n?.()},findProvider:({rdns:e})=>t.find(t=>t.info.rdns===e),getProviders:()=>t,reset(){this.clear(),n?.(),n=r()},subscribe:(r,{emitImmediately:n}={})=>(e.add(r),n&&r(t,{added:t}),()=>e.delete(r))}}class V{type="metamask";platform="ethereum";MMSDK;store=j();account=void 0;connectedAccounts=[];constructor(){this.MMSDK=new d.Mb({dappMetadata:{name:"Cartridge Controller",url:window.location.href}}),this.isAvailable()&&this.MMSDK.sdkInitPromise?.then(()=>{this.MMSDK.getProvider()?.request({method:"eth_accounts"}).then(e=>{e&&e.length>0&&(this.account=e[0],this.connectedAccounts=e)}),this.MMSDK.getProvider()?.on("accountsChanged",e=>{Array.isArray(e)&&(this.account=e?.[0],this.connectedAccounts=e)})})}isAvailable(){return"u">typeof window&&this.store.getProviders().some(e=>"io.metamask"===e.info.rdns)}getInfo(){let e=this.isAvailable();return{type:this.type,available:e,version:e?window.ethereum?.version||"Unknown":void 0,chainId:e?window.ethereum?.chainId:void 0,name:"MetaMask",platform:this.platform,connectedAccounts:this.connectedAccounts}}async connect(e){if(e&&this.connectedAccounts.includes(e)&&(this.account=e),this.account)return{success:!0,wallet:this.type,account:this.account};try{if(!this.isAvailable())throw Error("MetaMask is not available");let e=await this.MMSDK.connect();if(e&&e.length>0)return this.account=e[0],this.connectedAccounts=e,{success:!0,wallet:this.type,account:this.account};throw Error("No accounts found")}catch(e){return console.error("Error connecting to MetaMask:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}getConnectedAccounts(){return this.connectedAccounts}async signTransaction(e){try{if(!this.isAvailable()||!this.account)throw Error("MetaMask is not connected");let t=this.MMSDK.getProvider();if(!t)throw Error("MetaMask is not connected");let r=await t.request({method:"eth_sendTransaction",params:[e]});return{success:!0,wallet:this.type,result:r}}catch(e){return console.error("Error signing transaction with MetaMask:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}async signMessage(e){try{if(!this.isAvailable()||!this.account)throw Error("MetaMask is not connected");let t=await this.MMSDK.getProvider()?.request({method:"personal_sign",params:[this.account,e]});return{success:!0,wallet:this.type,result:t}}catch(e){return console.error("Error signing message with MetaMask:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}async signTypedData(e){try{if(!this.isAvailable()||!this.account)throw Error("MetaMask is not connected");let t=this.MMSDK.getProvider();if(!t)throw Error("MetaMask is not connected");let r=await t.request({method:"eth_signTypedData_v4",params:[this.account,JSON.stringify(e)]});return{success:!0,wallet:this.type,result:r}}catch(e){return console.error("Error signing typed data with MetaMask:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}async sendTransaction(e){return{success:!1,wallet:this.type,error:"Not implemented"}}async switchChain(e){try{if(!this.isAvailable())throw Error("MetaMask is not available");let t=this.MMSDK.getProvider();if(!t)throw Error("MetaMask is not connected");try{return await t.request({method:"wallet_switchEthereumChain",params:[{chainId:e}]}),!0}catch(e){throw 4902===e.code&&console.warn("Chain not added to MetaMask"),e}}catch(e){return console.error("Error switching chain for MetaMask:",e),!1}}async getBalance(e){try{if(!this.isAvailable()||!this.account)throw Error("MetaMask is not connected");if(e)return{success:!1,wallet:this.type,error:"Not implemented for ERC20"};{let e=this.MMSDK.getProvider();if(!e)throw Error("MetaMask is not connected");let t=await e.request({method:"eth_getBalance",params:[this.account,"latest"]});return{success:!0,wallet:this.type,result:t}}}catch(e){return console.error("Error getting balance from MetaMask:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}}class W{type="phantom";platform="solana";account=void 0;connectedAccounts=[];getProvider(){if(typeof window>"u")throw Error("Not ready");let e=window.solana;if(!e?.isPhantom)throw Error("Phantom is not available");return e}isAvailable(){return"u">typeof window&&!!window.solana?.isPhantom}getInfo(){let e=this.isAvailable();return{type:this.type,available:e,version:"Unknown",name:"Phantom",platform:this.platform}}async connect(){if(this.account)return{success:!0,wallet:this.type,account:this.account};try{if(!this.isAvailable())throw Error("Phantom is not available");let e=await this.getProvider().connect();if(e.publicKey)return this.account=e.publicKey.toString(),{success:!0,wallet:this.type,account:this.account};throw Error("No accounts found")}catch(e){return console.error("Error connecting to Phantom:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}getConnectedAccounts(){return this.connectedAccounts}async signMessage(e){try{if(!this.isAvailable()||!this.account)throw Error("Phantom is not connected");let t=new TextEncoder().encode(e),r=await this.getProvider().signMessage(t,"utf8");return{success:!0,wallet:this.type,result:r}}catch(e){return console.error("Error signing message with Phantom:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}async sendTransaction(e){if(!this.isAvailable()||!this.account)throw Error("Phantom is not connected");try{let t=f.ZX.from(e),r=await this.getProvider().signAndSendTransaction(t);return{success:!0,wallet:this.type,result:r}}catch(e){return console.error("Error sending transaction with Phantom:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}async switchChain(e){return console.warn("Chain switching not supported for Phantom"),!1}async getBalance(e){try{if(!this.isAvailable()||!this.account)throw Error("Phantom is not connected");return{success:!0,wallet:this.type,result:"Implement based on Phantom API"}}catch(e){return console.error("Error getting balance from Phantom:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}}class K{type="rabby";platform="ethereum";account=void 0;store=j();provider;connectedAccounts=[];constructor(){this.provider=this.store.getProviders().find(e=>"io.rabby"===e.info.rdns),this.provider?.provider.request({method:"eth_accounts"}).then(e=>{this.connectedAccounts=e}),this.provider?.provider?.on("accountsChanged",e=>{e&&(this.connectedAccounts=e.map(e=>e.toLowerCase()),this.account=e?.[0]?.toLowerCase())})}isAvailable(){return!!this.provider}getInfo(){let e=this.isAvailable();return{type:this.type,available:e,version:e?window.ethereum?.version||"Unknown":void 0,chainId:e?window.ethereum?.chainId:void 0,name:"Rabby",platform:this.platform,connectedAccounts:this.connectedAccounts}}async connect(e){if(e&&this.connectedAccounts.includes(e.toLowerCase())&&(this.account=e.toLowerCase()),this.account)return{success:!0,wallet:this.type,account:this.account};try{if(!this.isAvailable())throw Error("Rabby is not available");let e=await this.provider?.provider.request({method:"eth_requestAccounts"});if(e&&e.length>0)return this.account=e[0],this.connectedAccounts=e,{success:!0,wallet:this.type,account:this.account};throw Error("No accounts found")}catch(e){return console.error("Error connecting to Rabby:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}getConnectedAccounts(){return this.connectedAccounts}async signTransaction(e){try{if(!this.isAvailable()||!this.account)throw Error("Rabby is not connected");let t=this.provider?.provider;if(!t)throw Error("Rabby is not connected");let r=await t.request({method:"eth_sendTransaction",params:[e]});return{success:!0,wallet:this.type,result:r}}catch(e){return console.error("Error signing transaction with Rabby:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}async signMessage(e){try{if(!this.isAvailable()||!this.account)throw Error("Rabby is not connected");let t=await this.provider?.provider.request({method:"personal_sign",params:[this.account,e]});return{success:!0,wallet:this.type,result:t}}catch(e){return console.error("Error signing message with Rabby:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}async signTypedData(e){try{if(!this.isAvailable()||!this.account)throw Error("Rabby is not connected");let t=this.provider?.provider;if(!t)throw Error("Rabby is not connected");let r=await t.request({method:"eth_signTypedData_v4",params:[this.account,JSON.stringify(e)]});return{success:!0,wallet:this.type,result:r}}catch(e){return console.error("Error signing typed data with Rabby:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}async sendTransaction(e){return{success:!1,wallet:this.type,error:"Not implemented"}}async switchChain(e){try{if(!this.isAvailable())throw Error("Rabby is not available");let t=this.provider?.provider;if(!t)throw Error("Rabby is not connected");try{return await t.request({method:"wallet_switchEthereumChain",params:[{chainId:e}]}),!0}catch(e){throw 4902===e.code&&console.warn("Chain not added to Rabby"),e}}catch(e){return console.error("Error switching chain for Rabby:",e),!1}}async getBalance(e){try{if(!this.isAvailable()||!this.account)throw Error("Rabby is not connected");if(e)return{success:!1,wallet:this.type,error:"Not implemented for ERC20"};{let e=this.provider?.provider;if(!e)throw Error("Rabby is not connected");let t=await e.request({method:"eth_getBalance",params:[this.account,"latest"]});return{success:!0,wallet:this.type,result:t}}}catch(e){return console.error("Error getting balance from Rabby:",e),{success:!1,wallet:this.type,error:e.message||"Unknown error"}}}}class q{walletAdapters;constructor(){this.walletAdapters=new Map;let e=new V;e.isAvailable()&&this.walletAdapters.set("metamask",e);let t=new W;t.isAvailable()&&this.walletAdapters.set("phantom",t);let r=new F;r.isAvailable()&&this.walletAdapters.set("argent",r);let n=new K;n.isAvailable()&&this.walletAdapters.set("rabby",n),"u">typeof window&&(window.wallet_bridge=this)}getIFrameMethods(){return{externalDetectWallets:e=>()=>this.detectWallets(),externalConnectWallet:e=>(e,t)=>this.connectWallet(e,t),externalSignMessage:e=>(e,t)=>this.signMessage(e,t),externalSignTypedData:e=>(e,t)=>this.signTypedData(e,t),externalSendTransaction:e=>(e,t)=>this.sendTransaction(e,t),externalGetBalance:e=>(e,t)=>this.getBalance(e,t)}}async detectWallets(){return Array.from(this.walletAdapters.values()).map(e=>e.getInfo())}getWalletAdapterByType(e){let t=this.walletAdapters.get(e);if(!t)throw Error(`Unsupported wallet type: ${e}`);return t}handleError(e,t,r,n){let i=t instanceof Error?t.message:"Unknown error",s="unknown";if("string"==typeof e){let t=this.getConnectedWalletAdapter(e);s=n??t?.type??e}else s=e;return console.error(`Error ${r} with ${e} wallet:`,t),{success:!1,wallet:s,error:i}}async connectWallet(e,t){try{let r=await this.getWalletAdapterByType(e).connect(t);if(r.success&&r.account)console.log(`Wallet ${e} connected with address ${r.account}`);else if(r.success&&!r.account)return console.error(`Wallet ${e} connected successfully but did not provide an address.`),{...r,success:!1,error:"Wallet connected but address not found."};return r}catch(t){return this.handleError(e,t,"connecting to")}}getConnectedWalletAdapter(e){let t;if((t="string"==typeof e?this.walletAdapters.values().find(t=>t.getConnectedAccounts().includes(e.toLowerCase())):this.walletAdapters.get(e))||"string"!=typeof e||(t=this.walletAdapters.values().find(t=>t.getConnectedAccounts().includes(e.toLowerCase()))),!t)throw Error(`Wallet with identifier ${e} is not connected or supported`);return t}async signMessage(e,t){let r;try{if(!(r=this.getConnectedWalletAdapter(e)).signMessage)throw Error(`Wallet type ${r.type} (identifier: ${e}) does not support signing messages`);return await r.signMessage(t)}catch(t){return this.handleError(e,t,"signing message with",r?.type)}}async signTypedData(e,t){let r;try{if(!(r=this.getConnectedWalletAdapter(e)).signTypedData)throw Error(`Wallet type ${r.type} (identifier: ${e}) does not support signing typed data`);return await r.signTypedData(t)}catch(t){return this.handleError(e,t,"signing typed data with",r?.type)}}async sendTransaction(e,t){let r;try{return r=this.getConnectedWalletAdapter(e),await r.sendTransaction(t)}catch(t){return this.handleError(e,t,"sending transaction with",r?.type)}}async getBalance(e,t){let r;try{return r=this.getConnectedWalletAdapter(e),await r.getBalance(t)}catch(t){return this.handleError(e,t,"getting balance from",r?.type)}}}class z extends _{walletBridge;constructor({url:e,policies:t,...r}){let n=new URL(e??l.K),i=new q;t&&n.searchParams.set("policies",encodeURIComponent(JSON.stringify(t))),super({...r,id:"controller-keychain",url:n,methods:i.getIFrameMethods()}),this.walletBridge=i,"u">typeof window&&(window.external_wallets=this.walletBridge)}getWalletBridge(){return this.walletBridge}}class X extends _{constructor({profileUrl:e,rpcUrl:t,version:r,username:n,slot:i,namespace:s,tokens:o,policies:a,...c}){let h=(e||l.P).replace(/\/$/,""),u=new URL(i?`${h}/account/${n}/slot/${i}`:`${h}/account/${n}`);if(i&&u.searchParams.set("ps",encodeURIComponent(i)),s&&u.searchParams.set("ns",encodeURIComponent(s)),r&&u.searchParams.set("v",encodeURIComponent(r)),u.searchParams.set("rpcUrl",encodeURIComponent(t)),o?.erc20&&u.searchParams.set("erc20",encodeURIComponent(o.erc20.toString())),a?.contracts){let e=Object.values(a.contracts).flatMap(e=>e.methods);u.searchParams.set("methods",encodeURIComponent(JSON.stringify(e)))}super({...c,id:"controller-profile",url:u})}}class J extends l.B{keychain;profile;options;iframes;selectedChain;chains;constructor(e){super(),this.selectedChain=e.defaultChainId,this.chains=new Map,this.iframes={keychain:new z({...e,onClose:this.keychain?.reset,onConnect:e=>{this.keychain=e}})},this.options=e,this.validateChains(e.chains),"u">typeof window&&(window.starknet_controller=this)}async probe(){try{if(await this.waitForKeychain(),!this.keychain)return void console.error(new l.N().message);let e=await this.keychain.probe(this.rpcUrl()),t=e?.rpcUrl||this.rpcUrl();this.account=new y(this,t,e.address,this.keychain,this.options,this.iframes.keychain)}catch(e){console.error(e);return}if(!this.iframes.profile){let e=await this.keychain.username();this.iframes.profile=new X({...this.options,onConnect:e=>{this.profile=e},methods:{openSettings:()=>this.openSettings.bind(this),openPurchaseCredits:()=>this.openPurchaseCredits.bind(this),openExecute:()=>this.openExecute.bind(this)},rpcUrl:this.rpcUrl(),username:e,version:this.version})}return this.account}async connect(){if(this.account)return this.account;if(!this.keychain||!this.iframes.keychain)return void console.error(new l.N().message);document.hasStorageAccess&&(await document.hasStorageAccess()||await document.requestStorageAccess()),this.iframes.keychain.open();try{let e=await this.keychain.connect(this.options.policies||{},this.rpcUrl());if(e.code!==l.R.SUCCESS)throw Error(e.message);return this.account=new y(this,this.rpcUrl(),e.address,this.keychain,this.options,this.iframes.keychain),this.account}catch(e){console.log(e)}finally{this.iframes.keychain.close()}}async switchStarknetChain(e){if(!this.keychain||!this.iframes.keychain)return console.error(new l.N().message),!1;try{if(this.selectedChain=e,(await this.keychain.probe(this.rpcUrl())).rpcUrl===this.rpcUrl())return!0;await this.keychain.switchChain(this.rpcUrl()),await this.profile?.switchChain(this.rpcUrl())}catch(e){return console.error(e),!1}return this.emitNetworkChanged(e),!0}addStarknetChain(e){return Promise.resolve(!0)}async disconnect(){return this.keychain?(document.hasStorageAccess&&(await document.hasStorageAccess()||await document.requestStorageAccess()),this.account=void 0,this.keychain.disconnect()):void console.error(new l.N().message)}async openProfile(e="inventory"){return this.profile&&this.iframes.profile?.url?this.account?void(this.profile.navigate(`${this.iframes.profile.url?.pathname}/${e}`),this.iframes.profile.open()):void console.error("Account is not ready"):void console.error("Profile is not ready")}async openProfileTo(e){return this.profile&&this.iframes.profile?.url?this.account?void(this.profile.navigate(`${this.iframes.profile.url?.pathname}/${e}`),this.iframes.profile.open()):void console.error("Account is not ready"):void console.error("Profile is not ready")}async openProfileAt(e){return this.profile&&this.iframes.profile?.url?this.account?void(this.profile.navigate(e),this.iframes.profile.open()):void console.error("Account is not ready"):void console.error("Profile is not ready")}async openSettings(){if(!this.keychain||!this.iframes.keychain)return console.error(new l.N().message),null;this.iframes.profile?.sendBackward?this.iframes.profile?.sendBackward():this.iframes.profile?.close(),this.iframes.keychain.open();let e=await this.keychain.openSettings();return this.iframes.keychain.close(),this.iframes.profile?.sendForward?.(),!(e&&e.code===l.R.NOT_CONNECTED)}revoke(e,t){return this.keychain?this.keychain.revoke(e):(console.error(new l.N().message),null)}rpcUrl(){let e=this.chains.get(this.selectedChain);if(!e){let e=Array.from(this.chains.keys()).map(e=>c.Gm.decodeShortString(e));throw Error(`Chain not found: ${c.Gm.decodeShortString(this.selectedChain)}. Available chains: ${e.join(", ")}`)}return e.rpcUrl}username(){return this.keychain?this.keychain.username():void console.error(new l.N().message)}openPurchaseCredits(){return this.keychain&&this.iframes.keychain?this.iframes.profile?void(this.iframes.profile.close(),this.iframes.keychain.open(),this.keychain.openPurchaseCredits()):void console.error("Profile is not ready"):void console.error(new l.N().message)}openStarterPack(e){return this.keychain&&this.iframes.keychain?this.iframes.profile?void(this.iframes.profile.close(),this.iframes.keychain.open(),this.keychain.openStarterPack(e)):void console.error("Profile is not ready"):void console.error(new l.N().message)}async openExecute(e,t){if(!this.keychain||!this.iframes.keychain)return void console.error(new l.N().message);if(!this.iframes.profile)return void console.error("Profile is not ready");let r=this.selectedChain;t&&this.switchStarknetChain(t),this.iframes.profile?.sendBackward(),this.iframes.keychain.open(),this.iframes.profile?.close();let n=await this.keychain.execute(e,void 0,void 0,!0);return this.iframes.profile?.open(),this.iframes.keychain.close(),this.iframes.profile?.sendForward(),t&&this.switchStarknetChain(r),{status:!(n&&(n.code===l.R.NOT_CONNECTED||n.code===l.R.CANCELED)),transactionHash:n?.transaction_hash}}async delegateAccount(){return this.keychain?await this.keychain.delegateAccount():(console.error(new l.N().message),null)}async validateChains(e){for(let t of e)try{let e=new URL(t.rpcUrl),r=await (0,l.p)(e);this.chains.set(r,t)}catch(e){console.error(`Failed to parse chainId for ${t.rpcUrl}:`,e)}this.chains.has(this.selectedChain)||console.warn(`Selected chain ${this.selectedChain} not found in configured chains. Available chains: ${Array.from(this.chains.keys()).join(", ")}`)}waitForKeychain({timeout:e=5e4,interval:t=100}={}){return new Promise((r,n)=>{let i=Date.now(),s=setInterval(()=>{if(Date.now()-i>e){clearInterval(s),n(Error("Timeout waiting for keychain"));return}this.keychain&&(clearInterval(s),r())},t)})}}function H(e,t,r){for(let r in t){let n=t[r];Object.defineProperty(e,r,{enumerable:!0,value:n,writable:!1})}}function G(e){if(null==e)return"null";if(Array.isArray(e))return"[ "+e.map(G).join(", ")+" ]";if(e instanceof Uint8Array){let t="0123456789abcdef",r="0x";for(let n=0;n<e.length;n++)r+=t[e[n]>>4],r+=t[15&e[n]];return r}if("object"==typeof e&&"function"==typeof e.toJSON)return G(e.toJSON());switch(typeof e){case"boolean":case"symbol":case"number":return e.toString();case"bigint":return BigInt(e).toString();case"string":return JSON.stringify(e);case"object":{let t=Object.keys(e);return t.sort(),"{ "+t.map(t=>`${G(t)}: ${G(e[t])}`).join(", ")+" }"}}return"[ COULD NOT SERIALIZE ]"}function Y(e,t,r,n){if(!e)throw function(e,t,r){let n,i=e;{let n=[];if(r){if("message"in r||"code"in r||"name"in r)throw Error(`value will overwrite populated values: ${G(r)}`);for(let e in r){if("shortMessage"===e)continue;let t=r[e];n.push(e+"="+G(t))}}n.push(`code=${t}`),n.push("version=6.13.7"),n.length&&(e+=" ("+n.join(", ")+")")}switch(t){case"INVALID_ARGUMENT":n=TypeError(e);break;case"NUMERIC_FAULT":case"BUFFER_OVERRUN":n=RangeError(e);break;default:n=Error(e)}return H(n,{code:t}),r&&Object.assign(n,r),null==n.shortMessage&&H(n,{shortMessage:i}),n}(t,r,n)}function Z(e,t,r,n){Y(e,t,"INVALID_ARGUMENT",{argument:r,value:n})}function Q(e,t){return function(e,t,r){if(e instanceof Uint8Array)return e;if("string"==typeof e&&e.match(/^0x(?:[0-9a-f][0-9a-f])*$/i)){let t=new Uint8Array((e.length-2)/2),r=2;for(let n=0;n<t.length;n++)t[n]=parseInt(e.substring(r,r+2),16),r+=2;return t}Z(!1,"invalid BytesLike value",t||"value",e)}(e,t)}function ee(e,t){return!("string"!=typeof e||!e.match(/^0x[0-9A-Fa-f]*$/)||"number"==typeof t&&e.length!==2+2*t||!0===t&&e.length%2!=0)}["NFD","NFC","NFKD","NFKC"].reduce((e,t)=>{try{if("test"!=="test".normalize(t))throw Error("bad");if("NFD"===t&&"é"!=="\xe9".normalize("NFD"))throw Error("broken");e.push(t)}catch{}return e},[]);let et="0123456789abcdef";function er(e){let t=Q(e),r="0x";for(let e=0;e<t.length;e++){let n=t[e];r+=et[(240&n)>>4]+et[15&n]}return r}function en(e){return"0x"+e.map(e=>er(e).substring(2)).join("")}function ei(e){return ee(e,!0)?(e.length-2)/2:Q(e).length}let es=BigInt(0);function eo(e,t){switch(typeof e){case"bigint":return e;case"number":return Z(Number.isInteger(e),"underflow",t||"value",e),Z(e>=-0x1fffffffffffff&&e<=0x1fffffffffffff,"overflow",t||"value",e),BigInt(e);case"string":try{if(""===e)throw Error("empty string");return"-"===e[0]&&"-"!==e[1]?-BigInt(e.substring(1)):BigInt(e)}catch(r){Z(!1,`invalid BigNumberish string: ${r.message}`,t||"value",e)}}Z(!1,"invalid BigNumberish value",t||"value",e)}function ea(e,t){switch(typeof e){case"bigint":return Z(e>=-0x1fffffffffffff&&e<=0x1fffffffffffff,"overflow",t||"value",e),Number(e);case"number":return Z(Number.isInteger(e),"underflow",t||"value",e),Z(e>=-0x1fffffffffffff&&e<=0x1fffffffffffff,"overflow",t||"value",e),e;case"string":try{if(""===e)throw Error("empty string");return ea(BigInt(e),t)}catch(r){Z(!1,`invalid numeric string: ${r.message}`,t||"value",e)}}Z(!1,"invalid numeric value",t||"value",e)}BigInt(1);function ec(e){if(!Number.isSafeInteger(e)||e<0)throw Error(`Wrong positive integer: ${e}`)}function el(e,...t){if(!(e instanceof Uint8Array))throw Error("Expected Uint8Array");if(t.length>0&&!t.includes(e.length))throw Error(`Expected Uint8Array of length ${t}, not of length=${e.length}`)}function eh(e,t=!0){if(e.destroyed)throw Error("Hash instance has been destroyed");if(t&&e.finished)throw Error("Hash#digest() has already been called")}let eu=e=>e instanceof Uint8Array,ed=e=>new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4));if(68!==new Uint8Array(new Uint32Array([0x11223344]).buffer)[0])throw Error("Non little-endian hardware is not supported");function ef(e){if("string"==typeof e&&(e=function(e){if("string"!=typeof e)throw Error(`utf8ToBytes expected string, got ${typeof e}`);return new Uint8Array(new TextEncoder().encode(e))}(e)),!eu(e))throw Error(`expected Uint8Array, got ${typeof e}`);return e}class ey{clone(){return this._cloneInto()}}let ep=BigInt(0x100000000-1),eg=BigInt(32),ew=(e,t,r)=>e<<r|t>>>32-r,em=(e,t,r)=>t<<r|e>>>32-r,ev=(e,t,r)=>t<<r-32|e>>>64-r,eb=(e,t,r)=>e<<r-32|t>>>64-r,[ek,eA,eE]=[[],[],[]],eC=BigInt(0),eI=BigInt(1),eP=BigInt(2),eS=BigInt(7),eM=BigInt(256),eU=BigInt(113);for(let e=0,t=eI,r=1,n=0;e<24;e++){[r,n]=[n,(2*r+3*n)%5],ek.push(2*(5*n+r)),eA.push((e+1)*(e+2)/2%64);let i=eC;for(let e=0;e<7;e++)(t=(t<<eI^(t>>eS)*eU)%eM)&eP&&(i^=eI<<(eI<<BigInt(e))-eI);eE.push(i)}let[eN,eR]=function(e,t=!1){let r=new Uint32Array(e.length),n=new Uint32Array(e.length);for(let i=0;i<e.length;i++){let{h:s,l:o}=function(e,t=!1){return t?{h:Number(e&ep),l:Number(e>>eg&ep)}:{h:0|Number(e>>eg&ep),l:0|Number(e&ep)}}(e[i],t);[r[i],n[i]]=[s,o]}return[r,n]}(eE,!0),e$=(e,t,r)=>r>32?ev(e,t,r):ew(e,t,r),ex=(e,t,r)=>r>32?eb(e,t,r):em(e,t,r);class eB extends ey{constructor(e,t,r,n=!1,i=24){if(super(),this.blockLen=e,this.suffix=t,this.outputLen=r,this.enableXOF=n,this.rounds=i,this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,ec(r),0>=this.blockLen||this.blockLen>=200)throw Error("Sha3 supports only keccak-f1600 function");this.state=new Uint8Array(200),this.state32=ed(this.state)}keccak(){(function(e,t=24){let r=new Uint32Array(10);for(let n=24-t;n<24;n++){for(let t=0;t<10;t++)r[t]=e[t]^e[t+10]^e[t+20]^e[t+30]^e[t+40];for(let t=0;t<10;t+=2){let n=(t+8)%10,i=(t+2)%10,s=r[i],o=r[i+1],a=e$(s,o,1)^r[n],c=ex(s,o,1)^r[n+1];for(let r=0;r<50;r+=10)e[t+r]^=a,e[t+r+1]^=c}let t=e[2],i=e[3];for(let r=0;r<24;r++){let n=eA[r],s=e$(t,i,n),o=ex(t,i,n),a=ek[r];t=e[a],i=e[a+1],e[a]=s,e[a+1]=o}for(let t=0;t<50;t+=10){for(let n=0;n<10;n++)r[n]=e[t+n];for(let n=0;n<10;n++)e[t+n]^=~r[(n+2)%10]&r[(n+4)%10]}e[0]^=eN[n],e[1]^=eR[n]}r.fill(0)})(this.state32,this.rounds),this.posOut=0,this.pos=0}update(e){eh(this);let{blockLen:t,state:r}=this,n=(e=ef(e)).length;for(let i=0;i<n;){let s=Math.min(t-this.pos,n-i);for(let t=0;t<s;t++)r[this.pos++]^=e[i++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:e,suffix:t,pos:r,blockLen:n}=this;e[r]^=t,(128&t)!=0&&r===n-1&&this.keccak(),e[n-1]^=128,this.keccak()}writeInto(e){eh(this,!1),el(e),this.finish();let t=this.state,{blockLen:r}=this;for(let n=0,i=e.length;n<i;){this.posOut>=r&&this.keccak();let s=Math.min(r-this.posOut,i-n);e.set(t.subarray(this.posOut,this.posOut+s),n),this.posOut+=s,n+=s}return e}xofInto(e){if(!this.enableXOF)throw Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return ec(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(function(e,t){el(e);let r=t.outputLen;if(e.length<r)throw Error(`digestInto() expects output buffer of length at least ${r}`)}(e,this),this.finished)throw Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,this.state.fill(0)}_cloneInto(e){let{blockLen:t,suffix:r,outputLen:n,rounds:i,enableXOF:s}=this;return e||(e=new eB(t,r,n,s,i)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=i,e.suffix=r,e.outputLen=n,e.enableXOF=s,e.destroyed=this.destroyed,e}}let eT=function(e){let t=t=>e().update(ef(t)).digest(),r=e();return t.outputLen=r.outputLen,t.blockLen=r.blockLen,t.create=()=>e(),t}(()=>new eB(136,1,32)),eD=!1,eO=function(e){return eT(e)},eL=eO;function e_(e){let t=Q(e,"data");return er(eL(t))}e_._=eO,e_.lock=function(){eD=!0},e_.register=function(e){if(eD)throw TypeError("keccak256 is locked");eL=e},Object.freeze(e_);let eF="0x0000000000000000000000000000000000000000000000000000000000000000",ej=BigInt(0),eV=BigInt(1),eW=BigInt(2),eK=BigInt(27),eq=BigInt(28),ez=BigInt(35),eX={};function eJ(e){var t=function(e){let t=function(e,t){let r=eo(e,t);return Y(r>=es,"unsigned value cannot be negative","NUMERIC_FAULT",{fault:"overflow",operation:"getUint",value:e}),r}(e,"value");if(t===es)return new Uint8Array([]);let r=t.toString(16);r.length%2&&(r="0"+r);let n=new Uint8Array(r.length/2);for(let e=0;e<n.length;e++){let t=2*e;n[e]=parseInt(r.substring(t,t+2),16)}return n}(e),r=0;let n=Q(t);Y(32>=n.length,"padding exceeds data length","BUFFER_OVERRUN",{buffer:new Uint8Array(n),length:32,offset:33});let i=new Uint8Array(32);return i.fill(0),i.set(n,32-n.length),er(i)}class eH{#e;#t;#r;#n;get r(){return this.#e}set r(e){Z(32===ei(e),"invalid r","value",e),this.#e=er(e)}get s(){return this.#t}set s(e){Z(32===ei(e),"invalid s","value",e);let t=er(e);Z(8>parseInt(t.substring(0,3)),"non-canonical s","value",t),this.#t=t}get v(){return this.#r}set v(e){let t=ea(e,"value");Z(27===t||28===t,"invalid v","v",e),this.#r=t}get networkV(){return this.#n}get legacyChainId(){let e=this.networkV;return null==e?null:eH.getChainId(e)}get yParity(){return+(27!==this.v)}get yParityAndS(){let e=Q(this.s);return this.yParity&&(e[0]|=128),er(e)}get compactSerialized(){return en([this.r,this.yParityAndS])}get serialized(){return en([this.r,this.s,this.yParity?"0x1c":"0x1b"])}constructor(e,t,r,n){(function(e,t,r){if(e!==t){let e=r,t="new";e+=".",Y(!1,`private constructor; use ${e}from* methods`,"UNSUPPORTED_OPERATION",{operation:t+=" "+r})}})(e,eX,"Signature"),this.#e=t,this.#t=r,this.#r=n,this.#n=null}[Symbol.for("nodejs.util.inspect.custom")](){return`Signature { r: "${this.r}", s: "${this.s}", yParity: ${this.yParity}, networkV: ${this.networkV} }`}clone(){let e=new eH(eX,this.r,this.s,this.v);return this.networkV&&(e.#n=this.networkV),e}toJSON(){let e=this.networkV;return{_type:"signature",networkV:null!=e?e.toString():null,r:this.r,s:this.s,v:this.v}}static getChainId(e){let t=eo(e,"v");return t==eK||t==eq?ej:(Z(t>=ez,"invalid EIP-155 v","v",e),(t-ez)/eW)}static getChainIdV(e,t){return eo(e)*eW+BigInt(35+t-27)}static getNormalizedV(e){let t=eo(e);return t===ej||t===eK?27:t===eV||t===eq?28:(Z(t>=ez,"invalid v","v",e),t&eV?27:28)}static from(e){function t(t,r){Z(t,r,"signature",e)}if(null==e)return new eH(eX,eF,eF,27);if("string"==typeof e){let r=Q(e,"signature");if(64===r.length){let e=er(r.slice(0,32)),t=r.slice(32,64),n=128&t[0]?28:27;return t[0]&=127,new eH(eX,e,er(t),n)}if(65===r.length){let e=er(r.slice(0,32)),n=r.slice(32,64);t((128&n[0])==0,"non-canonical s");let i=eH.getNormalizedV(r[64]);return new eH(eX,e,er(n),i)}t(!1,"invalid raw signature length")}if(e instanceof eH)return e.clone();let r=e.r;t(null!=r,"missing r");let n=eJ(r),i=function(e,r){if(null!=e)return eJ(e);if(null!=r){t(ee(r,32),"invalid yParityAndS");let e=Q(r);return e[0]&=127,er(e)}t(!1,"missing s")}(e.s,e.yParityAndS);t((128&Q(i)[0])==0,"non-canonical s");let{networkV:s,v:o}=function(e,r,n){if(null!=e){let t=eo(e);return{networkV:t>=ez?t:void 0,v:eH.getNormalizedV(t)}}if(null!=r)return t(ee(r,32),"invalid yParityAndS"),{v:128&Q(r)[0]?28:27};if(null!=n){switch(ea(n,"sig.yParity")){case 0:return{v:27};case 1:return{v:28}}t(!1,"invalid yParity")}t(!1,"missing v")}(e.v,e.yParityAndS,e.yParity),a=new eH(eX,n,i,o);return s&&(a.#n=s),t(null==e.yParity||ea(e.yParity,"sig.yParity")===a.yParity,"yParity mismatch"),t(null==e.yParityAndS||e.yParityAndS===a.yParityAndS,"yParityAndS mismatch"),a}}}}]);